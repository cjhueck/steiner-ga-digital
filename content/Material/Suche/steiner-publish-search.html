<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suche</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .row { margin: 8px 0; }
    input[type="text"] { width: 100%; max-width: 600px; padding: 8px; }
    label { margin-right: 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    .muted { color: #666; font-size: 0.9em; }
    ul { padding-left: 20px; }
    li { margin: 6px 0; }
    .warn { color: #b35a00; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <input id="term1" type="text" placeholder="Stichwort 1 (z. B. Erkenntnistheorie)">
  </div>
  <div class="row">
    <input id="term2" type="text" placeholder="Stichwort 2 (optional; UND-Verknüpfung)">
  </div>
  <div class="row">
    <strong>Suchbereich:</strong>
    <label><input type="radio" name="scope" value="title" checked> Titel</label>
    <label><input type="radio" name="scope" value="subheading"> Zwischenüberschrift [[#...]]</label>
    <label><input type="radio" name="scope" value="both"> Beides (Titel+Zwischenüberschrift)</label>
    <label><input type="radio" name="scope" value="fulltext"> Gesamter Text</label>
  </div>
  <div class="row">
    <button id="run">Suche starten</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="note" class="row muted"></div>
  <hr>
  <div id="results"></div>
</div>

<script>
(async function(){
  const BASE_URL = "https://publish.obsidian.md/steiner-ga/";
  const $ = (s)=>document.querySelector(s);
  const resultsEl = $("#results");
  const statusEl = $("#status");
  const noteEl = $("#note");

  // load index (must be alongside this file)
  let index;
  try {
    const res = await fetch("./publish-search-index.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Index not found");
    index = await res.json();
    statusEl.textContent = "Index geladen: " + (index.items?.length || 0) + " Vorträge";
  } catch(e) {
    resultsEl.innerHTML = '<p class="warn">Konnte <code>publish-search-index.json</code> nicht laden. Lege HTML & JSON in denselben Ordner.</p>';
    console.error(e);
    return;
  }

  const sample = (index.items||[])[0] || {};
  if (typeof sample.body === "undefined") {
    noteEl.innerHTML = '<span class="warn">Hinweis: Für "Gesamter Text" bitte den Index mit der neuen Exporter-Version (v1.1.0) neu erzeugen.</span>';
  }

  const gaNamePattern = /^GA\\d{3}\\s*\\(\\d+\\.?\\)\\s+.*?,\\s+.*?\\d{4}$/;
  const ensureSlash = (s) => s.endsWith('/') ? s : s + '/';

  const prep = s => (s||"").toLowerCase().trim();
  const includesAny = (h, n) => h.indexOf(n) !== -1;

  function passScope(item, term, scope){
    const t = prep(term);
    if (!t) return true;
    const title = (item.title||'').toLowerCase();
    const headings = (item.headings||[]).map(h => (h||'').toLowerCase());
    const body = (item.body||'').toLowerCase();
    const inTitle = includesAny(title, t);
    const inHeadings = headings.some(h => includesAny(h, t));
    const inBody = body ? includesAny(body, t) : false;
    if (scope === "title") return inTitle;
    if (scope === "subheading") return inHeadings;
    if (scope === "both") return (inTitle || inHeadings);
    if (scope === "fulltext") return (inBody || inTitle || inHeadings);
    return inTitle || inHeadings;
  }

  function toPublishLink(item){
    const raw = (item.path || item.title || '').replace(/\\.md$/i, '');
    const href = ensureSlash(BASE_URL) + encodeURI(raw);
    return `<a rel="noopener" href="${href}">[[${item.title}]]</a>`;
  }

  $("#run").addEventListener("click", () => {
    const term1 = prep($("#term1").value);
    const term2 = prep($("#term2").value);
    const scope = (document.querySelector('input[name="scope"]:checked')||{}).value || "title";
    if (!term1) {
      resultsEl.innerHTML = "<p>Bitte mindestens ein Stichwort eingeben.</p>";
      return;
    }
    const items = (index.items || []).filter(it => gaNamePattern.test(it.title||''));
    const out = [];
    for (const it of items){
      const ok1 = passScope(it, term1, scope);
      const ok2 = !term2 || passScope(it, term2, scope);
      if (ok1 && ok2) out.push(`<li>${toPublishLink(it)}</li>`);
    }
    resultsEl.innerHTML = out.length ? "<ul>"+out.join("")+"</ul>" : "<p>Keine passenden Vorträge gefunden.</p>";
  });
})();
</script>
</body>
</html>